{% extends 'core/base.html' %}
{% load static form_tags %}

{% block content %}
  <div class="bg-white p-6 rounded-xl shadow-md ring-1 ring-gray-200">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h2 class="text-2xl font-bold">ثبت دانش‌آموز جدید</h2>
        <p class="text-sm text-gray-500">فرم ثبت اطلاعات پایه دانش‌آموزان مرکز</p>
      </div>
      <div class="hidden sm:flex items-center gap-3">
        <a href="{% url 'core:student_list' %}" class="text-sm text-blue-600 hover:underline">بازگشت به لیست</a>
      </div>
    </div>

    <form method="post" enctype="multipart/form-data" class="grid grid-cols-1 md:grid-cols-3 gap-6 items-start">
      {% csrf_token %}

      <!-- Left: image upload -->
      <div class="md:col-span-1 flex flex-col items-center">
        <label class="block text-sm font-medium text-gray-700 mb-3">عکس دانش‌آموز</label>

        <div class="w-44 h-44 bg-gray-50 rounded-lg flex items-center justify-center overflow-hidden border border-dashed border-gray-200">
          <img id="preview" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'><rect fill='%23f3f4f6' width='200' height='200'/><g transform='translate(50,30)'><circle cx='50' cy='40' r='30' fill='%23e5e7eb'/><rect x='20' y='90' width='60' height='20' rx='10' fill='%23e5e7eb'/></g></svg>" alt="پیش‌نمایش" class="w-full h-full object-cover" />
        </div>

        <label for="id_image" class="mt-3 w-full inline-flex justify-center items-center px-3 py-2 bg-white border rounded-md text-sm text-gray-700 hover:bg-gray-50 cursor-pointer">
          انتخاب فایل
        </label>
        {{ form.image }}

        <p class="text-xs text-gray-400 mt-2">فرمت‌های مجاز: JPG, PNG — حداکثر 2MB</p>
      </div>

      <!-- Right: inputs -->
      <div class="md:col-span-2 space-y-4">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">نام و نام خانوادگی</label>
            {{ form.name|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
            {% if form.name.errors %}
              <p class="text-xs text-red-600 mt-1">{{ form.name.errors|striptags }}</p>
            {% endif %}
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">نام پدر</label>
            {{ form.father_name|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
            {% if form.father_name.errors %}
              <p class="text-xs text-red-600 mt-1">{{ form.father_name.errors|striptags }}</p>
            {% endif %}
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">نام پدر کلان</label>
            {{ form.grandfather_name|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
            {% if form.grandfather_name.errors %}
              <p class="text-xs text-red-600 mt-1">{{ form.grandfather_name.errors|striptags }}</p>
            {% endif %}
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">سکونت فعلی</label>
            {{ form.current_address|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
            {% if form.current_address.errors %}
              <p class="text-xs text-red-600 mt-1">{{ form.current_address.errors|striptags }}</p>
            {% endif %}
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700">سکونت اصلی</label>
            {{ form.permanent_address|add_class:'mt-1 block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
            {% if form.permanent_address.errors %}
              <p class="text-xs text-red-600 mt-1">{{ form.permanent_address.errors|striptags }}</p>
            {% endif %}
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">تایم</label>
          <div class="mt-1 grid grid-cols-2 gap-2 items-center">
            <div>
              <label class="block text-xs text-gray-600">تایم آغاز</label>
              {{ form.time_start|add_class:'mt-1 block w-full rounded-md border-gray-300' }}
            </div>
            <div>
              <label class="block text-xs text-gray-600">تایم ختم</label>
              {{ form.time_end|add_class:'mt-1 block w-full rounded-md border-gray-300' }}
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">نمبر تذکره</label>
              {{ form.id_number|add_class:'mt-1 block w-full rounded-md border-gray-300' }}
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">جنسیت</label>
              {{ form.gender|add_class:'mt-1 block w-full rounded-md border-gray-300' }}
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">نمبر امتحان کانکور</label>
              {{ form.exam_number|add_class:'mt-1 block w-full rounded-md border-gray-300' }}
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mt-4">صنف</label>
            <div id="classComboBoxContainer" class="relative mt-1">
              {{ form.class_name|add_class:'block w-full rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500 pr-10' }}
              <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
              </div>
            </div>
            {% if form.class_name.errors %}
              <p class="text-xs text-red-600 mt-1">{{ form.class_name.errors|striptags }}</p>
            {% endif %}
          </div>

          <label class="block text-sm font-medium text-gray-700 mt-4">شماره موبایل</label>
          {{ form.mobile_number|add_class:'mt-1 block w-1/2 rounded-md border-gray-300 border border-2 shadow-sm focus:border-blue-500 focus:ring-blue-500' }}
          {% if form.mobile_number.errors %}
            <p class="text-xs text-red-600 mt-1">{{ form.mobile_number.errors|striptags }}</p>
          {% endif %}
        </div>

        <div class="pt-2 flex items-center gap-3">
          <button type="submit" class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md shadow">ثبت دانش‌آموز</button>
          <a href="{% url 'core:student_list' %}" class="inline-flex items-center gap-2 border border-gray-300 px-4 py-2 rounded-md text-gray-700">انصراف</a>
        </div>
      </div>
    </form>
  </div>

  {# Embed class names as JSON for client-side search. Use safe json_script filter if available. #}
  {% if class_names %}
    {{ class_names|json_script:"classNames" }}
  {% else %}
    <script id="classNames" type="application/json">[]</script>
  {% endif %}

{% block extra_js %}
<script>
  (function(){
    const fileInput = document.querySelector('#id_image');
    const preview = document.getElementById('preview');
    if (!fileInput) return;

    // hide default file input (it's already rendered by Django field)
    fileInput.classList.add('hidden');

    fileInput.addEventListener('change', function(e){
      const file = this.files && this.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(ev){ preview.src = ev.target.result; };
      reader.readAsDataURL(file);
    });
  })();
</script>
<script>
  (function(){
    // Optimized searchable class combobox with keyboard navigation
    const raw = document.getElementById('classNames') && document.getElementById('classNames').textContent;
    let classNames = [];
    try { classNames = raw ? JSON.parse(raw) : []; } catch(e){ classNames = []; }

    const input = document.querySelector('#id_class_name');
    if (!input) return;

    const container = document.getElementById('classComboBoxContainer');
    if (!container) return;

    // Add autocomplete attribute
    input.setAttribute('autocomplete', 'off');
    input.setAttribute('placeholder', 'صنف را جستجو کنید یا وارد نمایید...');

    // Create dropdown
    const dropdown = document.createElement('div');
    dropdown.className = 'absolute z-50 left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-auto hidden';
    dropdown.style.top = '100%';
    container.appendChild(dropdown);

    let selectedIndex = -1;
    let currentMatches = [];

    function highlightMatch(text, query) {
      if (!query) return text;
      const regex = new RegExp(`(${query})`, 'gi');
      return text.replace(regex, '<mark class="bg-yellow-200 font-semibold">$1</mark>');
    }

    function renderDropdown(items, query) {
      dropdown.innerHTML = '';
      currentMatches = items;
      selectedIndex = -1;

      if (!items.length) {
        const emptyMsg = document.createElement('div');
        emptyMsg.className = 'px-4 py-3 text-sm text-gray-500 text-center';
        emptyMsg.textContent = 'هیچ صنفی یافت نشد';
        dropdown.appendChild(emptyMsg);
        dropdown.classList.remove('hidden');
        return;
      }

      items.forEach((name, index) => {
        const item = document.createElement('div');
        item.className = 'px-4 py-2.5 cursor-pointer hover:bg-blue-50 text-sm transition-colors flex items-center justify-between';
        item.setAttribute('data-index', index);
        
        const textSpan = document.createElement('span');
        textSpan.innerHTML = highlightMatch(name, query);
        item.appendChild(textSpan);

        // Add check icon for current value
        if (input.value === name) {
          const checkIcon = document.createElement('svg');
          checkIcon.className = 'w-5 h-5 text-blue-600';
          checkIcon.setAttribute('fill', 'currentColor');
          checkIcon.setAttribute('viewBox', '0 0 20 20');
          checkIcon.innerHTML = '<path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>';
          item.appendChild(checkIcon);
          item.classList.add('bg-blue-50', 'font-medium');
        }

        item.addEventListener('click', function() {
          input.value = name;
          dropdown.classList.add('hidden');
          input.focus();
        });

        dropdown.appendChild(item);
      });

      dropdown.classList.remove('hidden');
    }

    function selectItem(index) {
      const items = dropdown.querySelectorAll('[data-index]');
      items.forEach(item => item.classList.remove('bg-blue-100'));
      
      if (index >= 0 && index < items.length) {
        items[index].classList.add('bg-blue-100');
        items[index].scrollIntoView({ block: 'nearest' });
        selectedIndex = index;
      }
    }

    // Show all classes on focus
    input.addEventListener('focus', function() {
      const q = this.value.trim().toLowerCase();
      const matches = q ? classNames.filter(n => n.toLowerCase().includes(q)) : classNames;
      renderDropdown(matches.slice(0, 50), q);
    });

    // Filter on input
    input.addEventListener('input', function() {
      const q = this.value.trim().toLowerCase();
      if (!q) {
        renderDropdown(classNames.slice(0, 50), '');
        return;
      }
      
      const matches = classNames.filter(n => n.toLowerCase().includes(q));
      renderDropdown(matches.slice(0, 50), q);
    });

    // Keyboard navigation
    input.addEventListener('keydown', function(e) {
      const items = dropdown.querySelectorAll('[data-index]');
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (dropdown.classList.contains('hidden')) {
          input.focus();
        } else {
          selectItem(Math.min(selectedIndex + 1, items.length - 1));
        }
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectItem(Math.max(selectedIndex - 1, 0));
      } else if (e.key === 'Enter') {
        if (selectedIndex >= 0 && selectedIndex < currentMatches.length) {
          e.preventDefault();
          input.value = currentMatches[selectedIndex];
          dropdown.classList.add('hidden');
        }
      } else if (e.key === 'Escape') {
        dropdown.classList.add('hidden');
      }
    });

    // Hide dropdown on outside click
    document.addEventListener('click', function(e) {
      if (!container.contains(e.target)) {
        dropdown.classList.add('hidden');
      }
    });

    // Show dropdown on click
    input.addEventListener('click', function(e) {
      e.stopPropagation();
      if (dropdown.classList.contains('hidden')) {
        const q = this.value.trim().toLowerCase();
        const matches = q ? classNames.filter(n => n.toLowerCase().includes(q)) : classNames;
        renderDropdown(matches.slice(0, 50), q);
      }
    });
  })();
</script>
{% endblock %}

{% endblock %}
