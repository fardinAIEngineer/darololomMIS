{% extends 'core/base.html' %}
{% load static %}

{% block content %}
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700&display=swap');

    .ironman-shell {
      --hud-accent: 34 211 238;
      --hud-bg-1: #f7fbff;
      --hud-bg-2: #e8f0f7;
      --hud-glow-cyan: rgba(34, 211, 238, 0.16);
      --hud-glow-amber: rgba(249, 115, 22, 0.12);
      --hud-glow-rose: rgba(248, 113, 113, 0.12);
      --hud-grid-line: rgba(14, 116, 144, 0.08);
      --hud-grid-line-strong: rgba(14, 116, 144, 0.12);
      --hud-outline: rgba(14, 116, 144, 0.2);
      --hud-outline-soft: rgba(14, 116, 144, 0.18);
      --hud-shadow: rgba(14, 116, 144, 0.25);
      --hud-text-strong: #0f172a;
      --hud-text: #1e293b;
      --hud-muted: rgba(30, 41, 59, 0.7);
      --hud-panel-1: rgba(255, 255, 255, 0.92);
      --hud-panel-2: rgba(226, 232, 240, 0.85);
      --hud-panel-inset: rgba(148, 163, 184, 0.4);
      --hud-icon-base: rgba(255, 255, 255, 0.92);
      --hud-kpi-glow: rgba(14, 116, 144, 0.25);
      --hud-hover-glow: rgba(var(--hud-accent), 0.35);
      position: relative;
      border-radius: 28px;
      padding: 28px;
      background:
        radial-gradient(900px circle at 15% 0%, var(--hud-glow-cyan), transparent 55%),
        radial-gradient(700px circle at 85% 10%, var(--hud-glow-amber), transparent 60%),
        linear-gradient(180deg, var(--hud-bg-1) 0%, var(--hud-bg-2) 55%, var(--hud-bg-1) 100%);
      border: 1px solid var(--hud-outline);
      box-shadow:
        0 0 0 1px var(--hud-outline-soft),
        0 40px 120px -60px var(--hud-shadow);
      color: var(--hud-text);
      overflow: hidden;
      isolation: isolate;
    }

    html.dark .ironman-shell {
      --hud-bg-1: #070b14;
      --hud-bg-2: #0b1424;
      --hud-glow-cyan: rgba(34, 211, 238, 0.28);
      --hud-glow-amber: rgba(249, 115, 22, 0.22);
      --hud-glow-rose: rgba(248, 113, 113, 0.2);
      --hud-grid-line: rgba(56, 189, 248, 0.08);
      --hud-grid-line-strong: rgba(14, 116, 144, 0.18);
      --hud-outline: rgba(56, 189, 248, 0.2);
      --hud-outline-soft: rgba(56, 189, 248, 0.12);
      --hud-shadow: rgba(14, 116, 144, 0.9);
      --hud-text-strong: #e6f8ff;
      --hud-text: #e2e8f0;
      --hud-muted: rgba(148, 163, 184, 0.95);
      --hud-panel-1: rgba(15, 23, 42, 0.9);
      --hud-panel-2: rgba(2, 6, 23, 0.75);
      --hud-panel-inset: rgba(15, 23, 42, 0.7);
      --hud-icon-base: rgba(15, 23, 42, 0.9);
      --hud-kpi-glow: rgba(34, 211, 238, 0.5);
      --hud-hover-glow: rgba(var(--hud-accent), 0.45);
    }

    .ironman-shell::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        repeating-linear-gradient(90deg, var(--hud-grid-line) 0 1px, transparent 1px 60px),
        repeating-linear-gradient(0deg, var(--hud-grid-line) 0 1px, transparent 1px 60px),
        linear-gradient(transparent 0%, var(--hud-grid-line-strong) 2%, transparent 4%);
      opacity: 0.6;
      pointer-events: none;
      z-index: 0;
    }

    .ironman-shell::after {
      content: "";
      position: absolute;
      inset: -80px;
      background:
        radial-gradient(600px circle at 20% 20%, var(--hud-glow-cyan), transparent 60%),
        radial-gradient(500px circle at 80% 20%, var(--hud-glow-amber), transparent 60%),
        radial-gradient(400px circle at 50% 100%, var(--hud-glow-rose), transparent 60%);
      opacity: 0.7;
      pointer-events: none;
      z-index: 0;
    }

    .hud-title,
    .hud-section-title,
    .hud-kpi {
      font-family: 'Orbitron', 'Inter', system-ui, sans-serif;
    }

    .hud-title {
      color: var(--hud-text-strong);
      letter-spacing: 0.06em;
      text-shadow: 0 0 18px var(--hud-kpi-glow);
    }

    .hud-section-title {
      color: var(--hud-text-strong);
      letter-spacing: 0.04em;
    }

    .hud-subtitle {
      color: var(--hud-muted);
    }

    .hud-panel {
      position: relative;
      border-radius: 22px;
      background: linear-gradient(160deg, var(--hud-panel-1), var(--hud-panel-2));
      border: 1px solid rgba(var(--hud-accent), 0.35);
      box-shadow:
        inset 0 0 0 1px var(--hud-panel-inset),
        0 20px 60px -40px rgba(var(--hud-accent), 0.7);
      overflow: hidden;
      backdrop-filter: blur(6px);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .hud-panel::before {
      content: "";
      position: absolute;
      left: 16px;
      right: 16px;
      top: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(var(--hud-accent), 0.8), transparent);
      opacity: 0.7;
      pointer-events: none;
    }

    .hud-panel:hover {
      transform: translateY(-4px);
      box-shadow:
        0 0 30px var(--hud-hover-glow),
        0 25px 60px -35px rgba(var(--hud-accent), 0.9);
    }

    .hud-icon {
      background: radial-gradient(circle at 30% 30%, rgba(var(--hud-accent), 0.6), var(--hud-icon-base));
      border: 1px solid rgba(var(--hud-accent), 0.55);
      box-shadow: 0 0 18px rgba(var(--hud-accent), 0.5);
    }

    .hud-icon svg {
      filter: drop-shadow(0 0 8px rgba(var(--hud-accent), 0.9));
    }

    .hud-icon-mark {
      color: rgba(var(--hud-accent), 0.95);
    }

    .hud-chip {
      display: inline-flex;
      align-items: center;
      padding: 0.2rem 0.65rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      border: 1px solid rgba(var(--hud-accent), 0.55);
      background: rgba(var(--hud-accent), 0.12);
      color: rgba(var(--hud-accent), 1);
    }

    .hud-label {
      color: rgba(var(--hud-accent), 0.95);
      font-weight: 600;
    }

    .hud-kpi {
      color: var(--hud-text-strong);
      text-shadow: 0 0 20px var(--hud-kpi-glow);
    }

    .hud-meta {
      color: var(--hud-muted);
    }

    .hud-check {
      color: rgba(var(--hud-accent), 0.9);
    }

    .hud-chart canvas {
      filter: drop-shadow(0 0 16px rgba(var(--hud-accent), 0.35));
    }

    .hud-accent-cyan { --hud-accent: 34 211 238; }
    .hud-accent-sky { --hud-accent: 56 189 248; }
    .hud-accent-amber { --hud-accent: 251 146 60; }
    .hud-accent-rose { --hud-accent: 248 113 113; }

    @media (max-width: 640px) {
      .ironman-shell { padding: 20px; }
      .hud-title { letter-spacing: 0.03em; }
    }
  </style>

  <section class="ironman-shell">
    <div class="relative z-10 space-y-10">
      <!-- Page Header -->
      <div>
        <h1 class="hud-title text-3xl sm:text-4xl font-semibold mb-2">داشبورد</h1>
        <p class="hud-subtitle text-sm sm:text-base">خلاصه آمار و اطلاعات سیستم مدیریت دارالعلوم</p>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Students Card -->
        <div class="group hud-panel hud-accent-cyan p-6 transition-all duration-300">
          <div class="flex items-start justify-between mb-4">
            <div class="hud-icon p-3 rounded-xl">
              <svg class="w-7 h-7 hud-icon-mark" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
              </svg>
            </div>
            <span class="hud-chip">فعال</span>
          </div>
          <div>
            <div class="hud-label text-sm mb-1">کل دانش‌آموزان</div>
            <div class="hud-kpi text-3xl font-bold">{{ total_students }}</div>
            <div class="mt-2 flex items-center text-xs hud-meta">
              <svg class="w-4 h-4 ml-1 hud-check" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              ثبت شده در سیستم
            </div>
          </div>
        </div>

        <!-- Teachers Card -->
        <div class="group hud-panel hud-accent-amber p-6 transition-all duration-300">
          <div class="flex items-start justify-between mb-4">
            <div class="hud-icon p-3 rounded-xl">
              <svg class="w-7 h-7 hud-icon-mark" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
              </svg>
            </div>
            <span class="hud-chip">فعال</span>
          </div>
          <div>
            <div class="hud-label text-sm mb-1">کل اساتید</div>
            <div class="hud-kpi text-3xl font-bold">{{ total_teachers }}</div>
            <div class="mt-2 flex items-center text-xs hud-meta">
              <svg class="w-4 h-4 ml-1 hud-check" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              ثبت شده در سیستم
            </div>
          </div>
        </div>

        <!-- Subjects Card -->
        <div class="group hud-panel hud-accent-sky p-6 transition-all duration-300">
          <div class="flex items-start justify-between mb-4">
            <div class="hud-icon p-3 rounded-xl">
              <svg class="w-7 h-7 hud-icon-mark" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"/>
              </svg>
            </div>
            <span class="hud-chip">فعال</span>
          </div>
          <div>
            <div class="hud-label text-sm mb-1">کل مضامین</div>
            <div class="hud-kpi text-3xl font-bold">{{ total_subjects }}</div>
            <div class="mt-2 flex items-center text-xs hud-meta">
              <svg class="w-4 h-4 ml-1 hud-check" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              ثبت شده در سیستم
            </div>
          </div>
        </div>

        <!-- Classes Card -->
        <div class="group hud-panel hud-accent-rose p-6 transition-all duration-300">
          <div class="flex items-start justify-between mb-4">
            <div class="hud-icon p-3 rounded-xl">
              <svg class="w-7 h-7 hud-icon-mark" fill="currentColor" viewBox="0 0 20 20">
                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
              </svg>
            </div>
            <span class="hud-chip">فعال</span>
          </div>
          <div>
            <div class="hud-label text-sm mb-1">کل صنوف</div>
            <div class="hud-kpi text-3xl font-bold">{{ total_classes }}</div>
            <div class="mt-2 flex items-center text-xs hud-meta">
              <svg class="w-4 h-4 ml-1 hud-check" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              ثبت شده در سیستم
            </div>
          </div>
        </div>
      </div>

      <!-- Chart Section -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="hud-panel hud-accent-cyan p-8 hud-chart">
          <div class="mb-6">
            <h2 class="hud-section-title text-lg sm:text-xl font-semibold mb-1">تقسیم دانش‌آموزان براساس جنسیت</h2>
            <p class="hud-subtitle text-sm">نمودار دایره‌ای تعداد مذکر و مونث</p>
          </div>
          <div class="max-w-lg mx-auto">
            <canvas id="studentsPie" width="400" height="400"></canvas>
          </div>
        </div>

        <div class="hud-panel hud-accent-amber p-8 hud-chart">
          <div class="mb-6">
            <h2 class="hud-section-title text-lg sm:text-xl font-semibold mb-1">تعداد دانش‌آموزان براساس سطح</h2>
            <p class="hud-subtitle text-sm">نمودار میله‌ای به تفکیک عالی، متوسطه و ابتداییه</p>
          </div>
          <div class="max-w-lg mx-auto">
            <canvas id="studentsByLevelBar" width="400" height="300"></canvas>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- embed chart JSON safely in the page to avoid direct template tokens inside JS -->
  <script id="chart-data" type="application/json">{{ chart_json }}</script>
  <script id="level-chart-data" type="application/json">{{ level_chart_json }}</script>
  <script>
    (function(){
      const el = document.getElementById('chart-data');
      let chartData = {labels: [], data: []};
      try{
        chartData = JSON.parse(el ? el.textContent : '{}') || chartData;
      }catch(e){
        console.error('Failed to parse chart data', e);
      }

      const isDark = document.documentElement.classList.contains('dark');
      const hudText = isDark ? '#cbd5f5' : '#1e293b';
      const hudGrid = isDark ? 'rgba(56, 189, 248, 0.15)' : 'rgba(14, 116, 144, 0.18)';
      const hudBorder = isDark ? 'rgba(15, 23, 42, 0.8)' : 'rgba(255, 255, 255, 0.9)';
      const pieColors = isDark ? ['#22d3ee', '#fb923c'] : ['#0891b2', '#ea580c'];
      const barColors = isDark ? ['#22d3ee', '#38bdf8', '#fb923c'] : ['#0891b2', '#0284c7', '#ea580c'];
      const barBorder = isDark ? 'rgba(34, 211, 238, 0.7)' : 'rgba(14, 116, 144, 0.5)';

      const ctx = document.getElementById('studentsPie').getContext('2d');
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: chartData.labels,
          datasets: [{
            data: chartData.data,
            backgroundColor: pieColors,
            borderColor: hudBorder,
            borderWidth: 2,
            hoverOffset: 8,
          }]
        },
        options: {
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: hudText }
            }
          }
        }
      });

      const levelEl = document.getElementById('level-chart-data');
      let levelData = {labels: [], data: []};
      try{
        levelData = JSON.parse(levelEl ? levelEl.textContent : '{}') || levelData;
      }catch(e){
        console.error('Failed to parse level chart data', e);
      }

      const barCtx = document.getElementById('studentsByLevelBar').getContext('2d');
      new Chart(barCtx, {
        type: 'bar',
        data: {
          labels: levelData.labels,
          datasets: [{
            label: 'تعداد دانش‌آموزان',
            data: levelData.data,
            backgroundColor: barColors,
            borderColor: barBorder,
            borderWidth: 1,
            borderRadius: 6,
          }]
        },
        options: {
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              ticks: { color: hudText },
              grid: { color: hudGrid }
            },
            y: {
              beginAtZero: true,
              ticks: { precision: 0, color: hudText },
              grid: { color: hudGrid }
            }
          }
        }
      });
    })();
  </script>

  <!-- lucide icons -->
  <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/lucide.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      try{
        if (window.lucide && typeof lucide.createIcons === 'function') lucide.createIcons();
      }catch(e){ console.error('lucide init failed', e); }
    });
  </script>
  <!-- Fallback: if lucide doesn't load (CDN blocked/offline/CSP), inject minimal inline SVGs for our icons -->
  <script>
    (function(){
      function svg(str){
        const div = document.createElement('div');
        div.innerHTML = str.trim();
        return div.firstChild;
      }

      const icons = {
        'users': '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M17 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>',
        'user-check': '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M17 11l2 2 4-4"></path></svg>',
        'book-open': '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M2 7a2 2 0 0 1 2-2h7v14H4a2 2 0 0 1-2-2z"></path><path d="M22 7a2 2 0 0 0-2-2h-7v14h7a2 2 0 0 0 2-2z"></path></svg>',
        'layers': '<svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>'
      };

      // run after a short delay to allow lucide to replace if available
      window.setTimeout(function(){
        if (window.lucide && typeof lucide.createIcons === 'function') return; // lucide present

        document.querySelectorAll('[data-lucide]').forEach(function(el){
          const name = el.getAttribute('data-lucide');
          const fallback = icons[name];
          if (!fallback) return;
          try{
            const svgEl = svg(fallback);
            // preserve color by adding the same text-color class if present on parent
            if (el.className) svgEl.className.baseVal = el.className;
            el.replaceWith(svgEl);
          }catch(e){ /* ignore */ }
        });
      }, 300);
    })();
  </script>

{% endblock %}
