{% extends 'core/base.html' %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/pages/dashboard.css' %}">
{% endblock %}


{% block content %}
  

  <section class="ironman-shell">
    <div class="relative z-10 space-y-10">
      <!-- Page Header -->
      <div>
        <h1 class="hud-title text-3xl sm:text-4xl font-semibold mb-2">داشبورد</h1>
        <p class="hud-subtitle text-sm sm:text-base">خلاصه آمار و اطلاعات سیستم مدیریت دارالعلوم</p>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Students Card -->
        <div class="group hud-panel hud-accent-cyan p-6 transition-all duration-300">
          <div class="flex items-start justify-between mb-4">
            <div class="hud-icon p-3 rounded-xl">
              <svg class="w-7 h-7 hud-icon-mark" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
              </svg>
            </div>
            <span class="hud-chip">فعال</span>
          </div>
          <div>
            <div class="hud-label text-sm mb-1">کل دانش‌آموزان</div>
            <div class="hud-kpi text-3xl font-bold">{{ total_students }}</div>
            <div class="mt-2 flex items-center text-xs hud-meta">
              <svg class="w-4 h-4 ml-1 hud-check" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              ثبت شده در سیستم
            </div>
          </div>
        </div>

        <!-- Teachers Card -->
        <div class="group hud-panel hud-accent-amber p-6 transition-all duration-300">
          <div class="flex items-start justify-between mb-4">
            <div class="hud-icon p-3 rounded-xl">
              <svg class="w-7 h-7 hud-icon-mark" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
              </svg>
            </div>
            <span class="hud-chip">فعال</span>
          </div>
          <div>
            <div class="hud-label text-sm mb-1">کل اساتید</div>
            <div class="hud-kpi text-3xl font-bold">{{ total_teachers }}</div>
            <div class="mt-2 flex items-center text-xs hud-meta">
              <svg class="w-4 h-4 ml-1 hud-check" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              ثبت شده در سیستم
            </div>
          </div>
        </div>

        <!-- Subjects Card -->
        <div class="group hud-panel hud-accent-sky p-6 transition-all duration-300">
          <div class="flex items-start justify-between mb-4">
            <div class="hud-icon p-3 rounded-xl">
              <svg class="w-7 h-7 hud-icon-mark" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"/>
              </svg>
            </div>
            <span class="hud-chip">فعال</span>
          </div>
          <div>
            <div class="hud-label text-sm mb-1">کل مضامین</div>
            <div class="hud-kpi text-3xl font-bold">{{ total_subjects }}</div>
            <div class="mt-2 flex items-center text-xs hud-meta">
              <svg class="w-4 h-4 ml-1 hud-check" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              ثبت شده در سیستم
            </div>
          </div>
        </div>

        <!-- Classes Card -->
        <div class="group hud-panel hud-accent-rose p-6 transition-all duration-300">
          <div class="flex items-start justify-between mb-4">
            <div class="hud-icon p-3 rounded-xl">
              <svg class="w-7 h-7 hud-icon-mark" fill="currentColor" viewBox="0 0 20 20">
                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
              </svg>
            </div>
            <span class="hud-chip">فعال</span>
          </div>
          <div>
            <div class="hud-label text-sm mb-1">کل صنوف</div>
            <div class="hud-kpi text-3xl font-bold">{{ total_classes }}</div>
            <div class="mt-2 flex items-center text-xs hud-meta">
              <svg class="w-4 h-4 ml-1 hud-check" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              ثبت شده در سیستم
            </div>
          </div>
        </div>
      </div>

      <!-- Chart Section -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="hud-panel hud-accent-cyan p-8 hud-chart">
          <div class="mb-6">
            <h2 class="hud-section-title text-lg sm:text-xl font-semibold mb-1">تقسیم دانش‌آموزان براساس جنسیت</h2>
            <p class="hud-subtitle text-sm">نمودار دایره‌ای تعداد مذکر و مونث</p>
          </div>
          <div class="max-w-lg mx-auto">
            <canvas id="studentsPie" width="400" height="400"></canvas>
          </div>
        </div>

        <div class="hud-panel hud-accent-amber p-8 hud-chart">
          <div class="mb-6">
            <h2 class="hud-section-title text-lg sm:text-xl font-semibold mb-1">تعداد دانش‌آموزان براساس سطح</h2>
            <p class="hud-subtitle text-sm">نمودار میله‌ای به تفکیک عالی، متوسطه و ابتداییه</p>
          </div>
          <div class="max-w-lg mx-auto">
            <canvas id="studentsByLevelBar" width="400" height="300"></canvas>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- embed chart JSON safely in the page to avoid direct template tokens inside JS -->
  <script id="chart-data" type="application/json">{{ chart_json }}</script>
  <script id="level-chart-data" type="application/json">{{ level_chart_json }}</script>
  <script>
    (function(){
      function parseJson(id, fallback) {
        const node = document.getElementById(id);
        try {
          return JSON.parse(node ? node.textContent : '{}') || fallback;
        } catch (e) {
          console.error('Failed to parse json for', id, e);
          return fallback;
        }
      }

      function sanitizeNumber(value) {
        const num = Number(value);
        return Number.isFinite(num) && num > 0 ? num : 0;
      }

      function sanitizeSeries(series, fallbackLabel) {
        const labels = Array.isArray(series.labels) ? series.labels.map(String) : [];
        const data = Array.isArray(series.data) ? series.data.map(sanitizeNumber) : [];
        const length = Math.max(labels.length, data.length);
        if (!length) {
          return { labels: [fallbackLabel], data: [0] };
        }
        const safeLabels = [];
        const safeData = [];
        for (let i = 0; i < length; i += 1) {
          safeLabels.push(labels[i] || `مورد ${i + 1}`);
          safeData.push(data[i] || 0);
        }
        return { labels: safeLabels, data: safeData };
      }

      function fitCanvas(canvas) {
        if (!canvas) return null;
        const context = canvas.getContext('2d');
        if (!context) return null;
        const ratio = window.devicePixelRatio || 1;
        const cssWidth = canvas.getAttribute('width') ? Number(canvas.getAttribute('width')) : canvas.clientWidth;
        const cssHeight = canvas.getAttribute('height') ? Number(canvas.getAttribute('height')) : canvas.clientHeight;
        canvas.style.width = `${cssWidth}px`;
        canvas.style.height = `${cssHeight}px`;
        canvas.width = Math.max(1, Math.floor(cssWidth * ratio));
        canvas.height = Math.max(1, Math.floor(cssHeight * ratio));
        context.setTransform(ratio, 0, 0, ratio, 0, 0);
        return { ctx: context, width: cssWidth, height: cssHeight };
      }

      function roundRectPath(ctx, x, y, width, height, radius) {
        const r = Math.max(0, Math.min(radius, width / 2, height / 2));
        ctx.beginPath();
        ctx.moveTo(x + r, y);
        ctx.lineTo(x + width - r, y);
        ctx.arcTo(x + width, y, x + width, y + r, r);
        ctx.lineTo(x + width, y + height - r);
        ctx.arcTo(x + width, y + height, x + width - r, y + height, r);
        ctx.lineTo(x + r, y + height);
        ctx.arcTo(x, y + height, x, y + height - r, r);
        ctx.lineTo(x, y + r);
        ctx.arcTo(x, y, x + r, y, r);
        ctx.closePath();
      }

      function drawEmpty(canvas, message, colors) {
        const view = fitCanvas(canvas);
        if (!view) return;
        const { ctx, width, height } = view;
        ctx.clearRect(0, 0, width, height);
        ctx.fillStyle = colors.bg;
        roundRectPath(ctx, 0, 0, width, height, 12);
        ctx.fill();
        ctx.fillStyle = colors.text;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = '14px sans-serif';
        ctx.fillText(message, width / 2, height / 2);
      }

      function drawPie(canvas, labels, values, colors) {
        const total = values.reduce((acc, v) => acc + v, 0);
        if (total <= 0) {
          drawEmpty(canvas, 'داده‌ای برای نمایش وجود ندارد', colors);
          return;
        }

        const view = fitCanvas(canvas);
        if (!view) return;
        const { ctx, width, height } = view;
        ctx.clearRect(0, 0, width, height);

        const centerX = width / 2;
        const centerY = Math.max(90, height * 0.38);
        const radius = Math.min(width, height) * 0.25;
        let startAngle = -Math.PI / 2;

        values.forEach((value, index) => {
          const slice = (value / total) * Math.PI * 2;
          const endAngle = startAngle + slice;
          ctx.beginPath();
          ctx.moveTo(centerX, centerY);
          ctx.arc(centerX, centerY, radius, startAngle, endAngle);
          ctx.closePath();
          ctx.fillStyle = colors.pie[index % colors.pie.length];
          ctx.fill();
          ctx.lineWidth = 2;
          ctx.strokeStyle = colors.border;
          ctx.stroke();

          if (slice > 0.25) {
            const mid = startAngle + slice / 2;
            const tx = centerX + Math.cos(mid) * (radius * 0.62);
            const ty = centerY + Math.sin(mid) * (radius * 0.62);
            ctx.fillStyle = colors.pieLabel;
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(String(value), tx, ty);
          }

          startAngle = endAngle;
        });

        const legendStartY = centerY + radius + 24;
        labels.forEach((label, i) => {
          const y = legendStartY + i * 24;
          ctx.fillStyle = colors.pie[i % colors.pie.length];
          roundRectPath(ctx, Math.max(20, width * 0.2), y - 8, 12, 12, 3);
          ctx.fill();
          ctx.fillStyle = colors.text;
          ctx.font = '13px sans-serif';
          ctx.textAlign = 'right';
          ctx.textBaseline = 'middle';
          ctx.fillText(`${label}: ${values[i] || 0}`, width * 0.78, y - 2);
        });
      }

      function drawBars(canvas, labels, values, colors) {
        const view = fitCanvas(canvas);
        if (!view) return;
        const { ctx, width, height } = view;
        ctx.clearRect(0, 0, width, height);

        const pad = { top: 20, right: 12, bottom: 56, left: 44 };
        const chartWidth = Math.max(20, width - pad.left - pad.right);
        const chartHeight = Math.max(20, height - pad.top - pad.bottom);
        const maxValue = Math.max(...values, 0);
        const axisMax = maxValue > 0 ? maxValue : 1;
        const steps = 4;

        ctx.strokeStyle = colors.grid;
        ctx.lineWidth = 1;
        ctx.fillStyle = colors.text;
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'right';
        ctx.textBaseline = 'middle';

        for (let i = 0; i <= steps; i += 1) {
          const y = pad.top + chartHeight - (i / steps) * chartHeight;
          ctx.beginPath();
          ctx.moveTo(pad.left, y);
          ctx.lineTo(pad.left + chartWidth, y);
          ctx.stroke();
          const tickValue = Math.round((axisMax / steps) * i);
          ctx.fillText(String(tickValue), pad.left - 6, y);
        }

        const count = values.length || 1;
        const slot = chartWidth / count;
        const barWidth = Math.min(58, Math.max(16, slot * 0.6));

        values.forEach((value, i) => {
          const barHeight = (value / axisMax) * chartHeight;
          const x = pad.left + slot * i + (slot - barWidth) / 2;
          const y = pad.top + chartHeight - barHeight;
          ctx.fillStyle = colors.bars[i % colors.bars.length];
          roundRectPath(ctx, x, y, barWidth, barHeight, 6);
          ctx.fill();

          ctx.fillStyle = colors.text;
          ctx.font = '12px sans-serif';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'bottom';
          ctx.fillText(String(value), x + barWidth / 2, y - 4);

          ctx.textBaseline = 'top';
          ctx.fillText(labels[i] || `سطح ${i + 1}`, x + barWidth / 2, pad.top + chartHeight + 10);
        });

        ctx.strokeStyle = colors.axis;
        ctx.lineWidth = 1.2;
        ctx.beginPath();
        ctx.moveTo(pad.left, pad.top);
        ctx.lineTo(pad.left, pad.top + chartHeight);
        ctx.lineTo(pad.left + chartWidth, pad.top + chartHeight);
        ctx.stroke();
      }

      const isDark = document.documentElement.classList.contains('dark');
      const palette = {
        text: isDark ? '#cbd5f5' : '#1e293b',
        pieLabel: isDark ? '#082f49' : '#ffffff',
        grid: isDark ? 'rgba(56, 189, 248, 0.15)' : 'rgba(14, 116, 144, 0.18)',
        axis: isDark ? 'rgba(148, 163, 184, 0.8)' : 'rgba(71, 85, 105, 0.8)',
        border: isDark ? 'rgba(15, 23, 42, 0.8)' : 'rgba(255, 255, 255, 0.9)',
        bg: isDark ? 'rgba(15, 23, 42, 0.4)' : 'rgba(248, 250, 252, 0.9)',
        pie: isDark ? ['#22d3ee', '#fb923c'] : ['#0891b2', '#ea580c'],
        bars: isDark ? ['#22d3ee', '#38bdf8', '#fb923c'] : ['#0891b2', '#0284c7', '#ea580c']
      };

      const pieSeries = sanitizeSeries(parseJson('chart-data', { labels: [], data: [] }), 'جنسیت');
      const barSeries = sanitizeSeries(parseJson('level-chart-data', { labels: [], data: [] }), 'سطح');
      drawPie(document.getElementById('studentsPie'), pieSeries.labels, pieSeries.data, palette);
      drawBars(document.getElementById('studentsByLevelBar'), barSeries.labels, barSeries.data, palette);
    })();
  </script>

{% endblock %}
