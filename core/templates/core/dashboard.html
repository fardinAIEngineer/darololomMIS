{% extends 'core/base.html' %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/pages/dashboard.css' %}">
{% endblock %}


{% block content %}
  

  <section class="ironman-shell">
    <div class="relative z-10 space-y-10">
      <!-- Page Header -->
      <div>
        <h1 class="hud-title text-3xl sm:text-4xl font-semibold mb-2">داشبورد</h1>
        <p class="hud-subtitle text-sm sm:text-base">خلاصه آمار و اطلاعات سیستم مدیریت دارالعلوم</p>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Students Card -->
        <div class="group hud-panel hud-accent-cyan p-6 transition-all duration-300">
          <div class="flex items-start justify-between mb-4">
            <div class="hud-icon p-3 rounded-xl">
              <svg class="w-7 h-7 hud-icon-mark" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
              </svg>
            </div>
            <span class="hud-chip">فعال</span>
          </div>
          <div>
            <div class="hud-label text-sm mb-1">کل دانش‌آموزان</div>
            <div class="hud-kpi text-3xl font-bold">{{ total_students }}</div>
            <div class="mt-2 flex items-center text-xs hud-meta">
              <svg class="w-4 h-4 ml-1 hud-check" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              ثبت شده در سیستم
            </div>
          </div>
        </div>

        <!-- Teachers Card -->
        <div class="group hud-panel hud-accent-amber p-6 transition-all duration-300">
          <div class="flex items-start justify-between mb-4">
            <div class="hud-icon p-3 rounded-xl">
              <svg class="w-7 h-7 hud-icon-mark" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"/>
              </svg>
            </div>
            <span class="hud-chip">فعال</span>
          </div>
          <div>
            <div class="hud-label text-sm mb-1">کل اساتید</div>
            <div class="hud-kpi text-3xl font-bold">{{ total_teachers }}</div>
            <div class="mt-2 flex items-center text-xs hud-meta">
              <svg class="w-4 h-4 ml-1 hud-check" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              ثبت شده در سیستم
            </div>
          </div>
        </div>

        <!-- Subjects Card -->
        <div class="group hud-panel hud-accent-sky p-6 transition-all duration-300">
          <div class="flex items-start justify-between mb-4">
            <div class="hud-icon p-3 rounded-xl">
              <svg class="w-7 h-7 hud-icon-mark" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"/>
              </svg>
            </div>
            <span class="hud-chip">فعال</span>
          </div>
          <div>
            <div class="hud-label text-sm mb-1">کل مضامین</div>
            <div class="hud-kpi text-3xl font-bold">{{ total_subjects }}</div>
            <div class="mt-2 flex items-center text-xs hud-meta">
              <svg class="w-4 h-4 ml-1 hud-check" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              ثبت شده در سیستم
            </div>
          </div>
        </div>

        <!-- Classes Card -->
        <div class="group hud-panel hud-accent-rose p-6 transition-all duration-300">
          <div class="flex items-start justify-between mb-4">
            <div class="hud-icon p-3 rounded-xl">
              <svg class="w-7 h-7 hud-icon-mark" fill="currentColor" viewBox="0 0 20 20">
                <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
              </svg>
            </div>
            <span class="hud-chip">فعال</span>
          </div>
          <div>
            <div class="hud-label text-sm mb-1">کل صنوف</div>
            <div class="hud-kpi text-3xl font-bold">{{ total_classes }}</div>
            <div class="mt-2 flex items-center text-xs hud-meta">
              <svg class="w-4 h-4 ml-1 hud-check" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              ثبت شده در سیستم
            </div>
          </div>
        </div>
      </div>

      <!-- Chart Section -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="hud-panel hud-accent-cyan p-8 hud-chart">
          <div class="mb-6">
            <h2 class="hud-section-title text-lg sm:text-xl font-semibold mb-1">تقسیم دانش‌آموزان براساس جنسیت</h2>
            <p class="hud-subtitle text-sm">نمودار دایره‌ای تعداد مذکر و مونث</p>
          </div>
          <div class="max-w-lg mx-auto">
            <canvas id="studentsPie" width="400" height="400"></canvas>
          </div>
        </div>

        <div class="hud-panel hud-accent-amber p-8 hud-chart">
          <div class="mb-6">
            <h2 class="hud-section-title text-lg sm:text-xl font-semibold mb-1">تعداد دانش‌آموزان براساس سطح</h2>
            <p class="hud-subtitle text-sm">نمودار میله‌ای به تفکیک عالی، متوسطه و ابتداییه</p>
          </div>
          <div class="max-w-lg mx-auto">
            <canvas id="studentsByLevelBar" width="400" height="300"></canvas>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- embed chart JSON safely in the page to avoid direct template tokens inside JS -->
  <script id="chart-data" type="application/json">{{ chart_json }}</script>
  <script id="level-chart-data" type="application/json">{{ level_chart_json }}</script>
  <script>
    (function(){
      const el = document.getElementById('chart-data');
      let chartData = {labels: [], data: []};
      try{
        chartData = JSON.parse(el ? el.textContent : '{}') || chartData;
      }catch(e){
        console.error('Failed to parse chart data', e);
      }

      const isDark = document.documentElement.classList.contains('dark');
      const hudText = isDark ? '#cbd5f5' : '#1e293b';
      const hudGrid = isDark ? 'rgba(56, 189, 248, 0.15)' : 'rgba(14, 116, 144, 0.18)';
      const hudBorder = isDark ? 'rgba(15, 23, 42, 0.8)' : 'rgba(255, 255, 255, 0.9)';
      const pieColors = isDark ? ['#22d3ee', '#fb923c'] : ['#0891b2', '#ea580c'];
      const barColors = isDark ? ['#22d3ee', '#38bdf8', '#fb923c'] : ['#0891b2', '#0284c7', '#ea580c'];
      const barBorder = isDark ? 'rgba(34, 211, 238, 0.7)' : 'rgba(14, 116, 144, 0.5)';
      const levelEl = document.getElementById('level-chart-data');
      let levelData = {labels: [], data: []};
      try{
        levelData = JSON.parse(levelEl ? levelEl.textContent : '{}') || levelData;
      }catch(e){
        console.error('Failed to parse level chart data', e);
      }

      if (typeof window.Chart !== 'function') {
        const pieBox = document.getElementById('studentsPie');
        const barBox = document.getElementById('studentsByLevelBar');
        if (pieBox && pieBox.parentElement) {
          pieBox.parentElement.innerHTML =
            '<div class=\"p-4 rounded-lg bg-gray-50 text-sm text-gray-700\">نمودار بدون: ' +
            `${chartData.labels.map((label, i) => `${label}: ${chartData.data[i] || 0}`).join(' | ')}` +
            '</div>';
        }
        if (barBox && barBox.parentElement) {
          barBox.parentElement.innerHTML =
            '<div class=\"p-4 rounded-lg bg-gray-50 text-sm text-gray-700\">آمار سطوح: ' +
            `${levelData.labels.map((label, i) => `${label}: ${levelData.data[i] || 0}`).join(' | ')}` +
            '</div>';
        }
        return;
      }

      const ctx = document.getElementById('studentsPie').getContext('2d');
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: chartData.labels,
          datasets: [{
            data: chartData.data,
            backgroundColor: pieColors,
            borderColor: hudBorder,
            borderWidth: 2,
            hoverOffset: 8,
          }]
        },
        options: {
          plugins: {
            legend: {
              position: 'bottom',
              labels: { color: hudText }
            }
          }
        }
      });

      const barCtx = document.getElementById('studentsByLevelBar').getContext('2d');
      new Chart(barCtx, {
        type: 'bar',
        data: {
          labels: levelData.labels,
          datasets: [{
            label: 'تعداد دانش‌آموزان',
            data: levelData.data,
            backgroundColor: barColors,
            borderColor: barBorder,
            borderWidth: 1,
            borderRadius: 6,
          }]
        },
        options: {
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              ticks: { color: hudText },
              grid: { color: hudGrid }
            },
            y: {
              beginAtZero: true,
              ticks: { precision: 0, color: hudText },
              grid: { color: hudGrid }
            }
          }
        }
      });
    })();
  </script>

{% endblock %}
